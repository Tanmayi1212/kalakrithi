rules_version = '2';

/**
 * Firestore Security Rules for Kalakrithi Admin Dashboard
 * 
 * Security Model:
 * - Public read access for workshops and slots
 * - Users can submit payment information (pendingPayments)
 * - Only admins can confirm/reject payments
 * - Only admins can create bookings
 * - Admins can manage slot capacity
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // ============================================
    // ADMINS COLLECTION
    // ============================================
    match /admins/{uid} {
      // Users can read their own admin document
      allow read: if isAuthenticated() && request.auth.uid == uid;
      
      // Only create via Firebase Console or Admin SDK
      allow write: if false;
    }

    // ============================================
    // PENDING PAYMENTS COLLECTION
    // ============================================
    match /pendingPayments/{paymentId} {
      // Anyone can read (for verification)
      allow read: if true;
      
      // Authenticated users can create pending payments
      allow create: if isAuthenticated() &&
                      request.resource.data.status == "submitted";
      
      // Only admins can update status to confirmed/rejected
      allow update: if isAdmin() &&
                      request.resource.data.status in ['confirmed', 'rejected'] &&
                      (
                        (request.resource.data.status == 'confirmed' &&
                         request.resource.data.keys().hasAll(['confirmedBy', 'confirmedAt'])) ||
                        (request.resource.data.status == 'rejected' &&
                         request.resource.data.keys().hasAll(['rejectedBy', 'rejectedAt']))
                      );
      
      // Only admins can delete
      allow delete: if isAdmin();
    }

    // ============================================
    // WORKSHOPS COLLECTION
    // ============================================
    match /workshops/{workshopId} {
      // Allow everyone to read workshop data
      allow read: if true;
      
      // Only admins can write workshop data
      allow write: if isAdmin();

      // SLOTS SUBCOLLECTION
      match /slots/{slotId} {
        // Allow everyone to read slots
        allow read: if true;
        
        // Only admins can modify slots (capacity, status)
        allow write: if isAdmin();

        // BOOKINGS SUBCOLLECTION
        match /bookings/{rollNumber} {
          // Allow everyone to read bookings (for verification)
          allow read: if true;
          
          // Allow authenticated users to create their OWN booking
          // Must include all required fields
          allow create: if isAuthenticated() &&
                          request.resource.data.rollNumber == rollNumber &&
                          request.resource.data.keys().hasAll([
                            'name', 'email', 'rollNumber', 'phone',
                            'workshopId', 'slotId', 'createdAt', 'paymentStatus'
                          ]);
          
          // Only admins can update bookings (for attendance or payment confirmation)
          allow update: if isAdmin();
          
          // Only admins can delete bookings
          allow delete: if isAdmin();
        }
      }

      // REGISTRATIONS SUBCOLLECTION (legacy - keep for backward compatibility)
      match /registrations/{rollNumber} {
        // Allow everyone to read registrations (for verification)
        allow read: if true;
        
        // All writes handled by Cloud Functions only
        allow write: if false;
      }
    }

    // ============================================
    // ARANGETRA GAMES COLLECTION
    // ============================================
    match /arangetraGames/{gameId} {
      // Allow everyone to read game data
      allow read: if true;
      
      // Only Cloud Functions (Admin SDK) can create/update/delete games
      allow write: if false;

      // REGISTRATIONS SUBCOLLECTION
      match /registrations/{rollNumber} {
        // Allow everyone to read registrations (for verification)
        allow read: if true;
        
        // All writes handled by Cloud Functions only
        allow write: if false;
      }
    }

    // ============================================
    // DENY ALL OTHER ACCESSES
    // ============================================
    // Any collection not explicitly allowed above is denied by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
