rules_version = '2';

/**
 * Firestore Security Rules for Kalakrithi Ã— Arangetra
 * 
 * Security Model:
 * - Public read access for workshops, slots, and games
 * - All writes restricted to Cloud Functions (server-side only)
 * - Authentication required for workshop bookings (enforced in Cloud Functions)
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if request is from Cloud Functions
    // In production, only Cloud Functions can write to protected collections
    function isServerRequest() {
      // Cloud Functions bypass security rules when using Admin SDK
      // This helper is for documentation purposes
      return true;
    }

    // ============================================
    // WORKSHOPS COLLECTION
    // ============================================
    match /workshops/{workshopId} {
      // Allow everyone to read workshop data
      allow read: if true;
      
      // Only admins/Cloud Functions can create/update/delete workshops
      // In practice, use Admin SDK from Cloud Functions
      allow write: if false;

      // SLOTS SUBCOLLECTION
      match /slots/{slotId} {
        // Allow everyone to read slot data
        allow read: if true;
        
        // Only Cloud Functions can modify slots
        allow write: if false;

        // BOOKINGS SUBCOLLECTION
        match /bookings/{rollNumber} {
          // Allow everyone to read bookings (for verification purposes)
          allow read: if true;
          
          // CRITICAL SECURITY: Prevent ALL direct client writes to bookings
          // All bookings MUST be created through Cloud Functions only
          // This prevents:
          // - Bypassing capacity limits
          // - Creating fake bookings
          // - Modifying payment IDs
          // - Race conditions
          allow create: if false;
          allow update: if false;
          allow delete: if false;
        }
      }
    }

    // ============================================
    // ARANGETRA GAMES COLLECTION
    // ============================================
    match /arangetraGames/{gameId} {
      // Allow everyone to read game data
      allow read: if true;
      
      // Only Cloud Functions can create/update/delete games
      allow write: if false;

      // REGISTRATIONS SUBCOLLECTION
      match /registrations/{registrationId} {
        // Allow everyone to read registrations
        allow read: if true;
        
        // CRITICAL SECURITY: Prevent ALL direct client writes to registrations
        // All registrations MUST be created through Cloud Functions only
        // This prevents:
        // - Bypassing duplicate checks
        // - Creating fake registrations
        // - Modifying registration data
        allow create: if false;
        allow update: if false;
        allow delete: if false;
      }
    }

    // ============================================
    // DENY ALL OTHER ACCESSES
    // ============================================
    // Any collection not explicitly allowed above is denied by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
